name: Auto Review & Fix

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install GitHub CLI Copilot extension
        run: gh extension install github/gh-copilot || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Review & Fix Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          MAX_ITERATIONS=5
          ITERATION=0
          
          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            echo "ğŸ”„ Iteration $((ITERATION + 1))/$MAX_ITERATIONS"
            
            # Copilot review tetikle
            echo "ğŸ“ Requesting Copilot review..."
            gh pr review $PR_NUMBER --comment -b "ğŸ¤– Copilot, please review this PR for any critical issues, bugs, or improvements."
            
            # Review yorumlarÄ±nÄ± al
            sleep 10  # Review'Ä±n tamamlanmasÄ± iÃ§in bekle
            REVIEWS=$(gh pr view $PR_NUMBER --json reviews --jq '.reviews[-1].body')
            
            # Copilot ile kritiklik analizi
            echo "ğŸ” Analyzing review comments..."
            CRITICAL_CHECK=$(echo "$REVIEWS" | gh copilot suggest -t shell "Bu review yorumlarÄ±nda critical, blocking, must fix gibi ciddi sorunlar var mÄ±? Sadece 'YES' veya 'NO' cevabÄ± ver.")
            
            if [[ "$CRITICAL_CHECK" == *"NO"* ]] || [ -z "$REVIEWS" ]; then
              echo "âœ… No critical issues found!"
              gh pr comment $PR_NUMBER --body "âœ… **Otomatik review tamamlandÄ±!**

Copilot tarafÄ±ndan yapÄ±lan incelemede kritik sorun bulunamadÄ±. 

PR'Ä± merge edebilirsiniz. ğŸš€"
              exit 0
            fi
            
            # Kritik sorunlarÄ± bul ve dÃ¼zelt
            echo "ğŸ”§ Fixing critical issues..."
            echo "$REVIEWS" | gh copilot suggest -t git "Bu review yorumlarÄ±ndaki kritik sorunlarÄ± dÃ¼zelt ve deÄŸiÅŸiklikleri commit et"
            
            # DeÄŸiÅŸiklikler varsa commit & push
            if [ -n "$(git status --porcelain)" ]; then
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add .
              git commit -m "fix: address copilot review comments (iteration $((ITERATION + 1)))"
              git push
              echo "âœ… Fixes pushed, waiting for next review..."
              sleep 15
            else
              echo "âš ï¸ No changes made by Copilot"
            fi
            
            ITERATION=$((ITERATION + 1))
          done
          
          # Max iterasyona ulaÅŸÄ±ldÄ±
          echo "âš ï¸ Max iterations reached"
          gh pr comment $PR_NUMBER --body "âš ï¸ **Otomatik review dÃ¶ngÃ¼sÃ¼ tamamlandÄ±**

$MAX_ITERATIONS iterasyon sonunda bazÄ± sorunlar hala mevcut olabilir. Manuel kontrol Ã¶nerilir."
